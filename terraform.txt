terraform {
  required_providers {
    proxmox = {
      source = "telmate/proxmox"
      version = "2.7.4"
    }
  }
}

provider "proxmox" {
  pm_api_url = "https://192.168.178.210:8006/api2/json"
  pm_api_token_id = "blog_example@pam!new_token_id"
  pm_api_token_secret = "47e03114-d1c2-4ccb-aabc-e90267329bba"
  pm_tls_insecure = true
}

resource "proxmox_vm_qemu" "test_master" {
  count = 0
  name = "master-${count.index + 1}"
  target_node = var.proxmox_host
  clone = var.template_name

  agent = 1
  os_type = "cloud-init"
  cores = 2
  sockets = 1
  cpu = "host"
  memory = 2048
  scsihw = "virtio-scsi-pci"
  bootdisk = "scsi0"

  disk {
    slot = 0
    size = "10G"
    type = "scsi"
    storage = "local-lvm"
    iothread = 1
  }

  network {
    model = "virtio"
    bridge = "vmbr0"
  }

  lifecycle {
    ignore_changes = [
      network,
    ]
  }

  ipconfig0 = "ip=192.168.178.9${count.index + 1}/24,gw=192.168.178.1"

  sshkeys = <<EOF
  ${var.ssh_key}
  ${var.ssh_key2}
  EOF
}

resource "proxmox_vm_qemu" "test_worker" {
  count = 3
  name = "worker-${count.index + 1}"
  target_node = var.proxmox_host
  clone = var.template_name

  agent = 1
  os_type = "cloud-init"
  cores = 4
  sockets = 1
  cpu = "host"
  memory = 4096
  scsihw = "virtio-scsi-pci"
  bootdisk = "scsi0"

  disk {
    slot = 0
    size = "10G"
    type = "scsi"
    storage = "local-lvm"
    iothread = 1
  }

  network {
    model = "virtio"
    bridge = "vmbr0"
  }

  lifecycle {
    ignore_changes = [
      network,
    ]
  }

  ipconfig0 = "ip=192.168.178.10${count.index + 1}/24,gw=192.168.178.1"

  sshkeys = <<EOF
  ${var.ssh_key}
  ${var.ssh_key2}
  EOF
}









variable "ssh_key" {
  default = "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCgCe5qKv9yEUlk7JxMXGhfOMxDcQmmgJpmJ/ENcoehDodMpBre7fT5uRzkKzv000UVT0NJlh8IobSZaPkTs+4Ko89HUtIoekd2ygyAcwg2g3UL/quaXjgC58QzsQ2NrC76O/lgg4XZE/XB40TmLt+mdc6AW+Py243q/3GhdMVwAkB26WxTdCC13r0oyCVC9rlxuZfEqQDUeYV7Uhem1u/g0Hokex3iPtvOPqyP2q3nrTjU8S1ln+9U9vEyMt3GSN2AIOc6DlXZrHlZD62Pv7H9E1rJd3exFKvv22Ah2T28yWjAfcQpyWN6KzIg72N0W5uWtYq7qi1xJGIyWJ5JwbZL+5srd7FHHx/xPzV/LxlaKOI4G+nGJML3NU+x8L1AyJQw00kIvMIq0CkfprBSgJAwlzyABAbcTOCNgGGQ4qQ1w0JmrIEgF97yk8gZRs6so1aJEkPYONkQksPJRyXIrpV3iMO2X0/MS9bBWhZ6JtMGynMScp0xtwDXV4lP38oduwU= max@max.example.com"
}
variable "ssh_key2" {
  default = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFb/6E7qJrulFAVRkrwQcDZY6m57pj3TIIpxZCVNpoiy ansible"
}
variable "proxmox_host" {
  default = "pve2"
}
variable "template_name" {
  default = "ubuntu-2004-cloudinit-template3"
}






